---
import BackgroundEffect from '../components/BackgroundEffect.astro';
import Header from '../components/Header.astro';
import EquationModal from '../components/EquationModal.astro';
import '../styles/global.css';

interface Props {
  title?: string;
}

const { title = "Ken Xiao" } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Ken Xiao's Personal Blog" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <script is:inline>
      // Check for saved theme preference
      const theme = (() => {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      })();
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  </head>
  <body class="min-h-screen flex flex-col font-sans">
    <BackgroundEffect />
    <EquationModal />
    <Header />
    <main class="flex-grow container mx-auto px-4 py-8">
      <slot />
    </main>
    <footer class="py-6 text-center text-sm opacity-60">
      &copy; {new Date().getFullYear()} Ken Xiao. All rights reserved.
    </footer>
    
    <script>
      // Add copy buttons to code blocks
      function addCopyButtons() {
        document.querySelectorAll('pre:not(.code-block-ready)').forEach(pre =>{
          pre.classList.add('code-block-ready');
          
          const wrapper = document.createElement('div');
          wrapper.className = 'code-block-wrapper';
          pre.parentNode.insertBefore(wrapper, pre);
          wrapper.appendChild(pre);
          
          const button = document.createElement('button');
          button.className = 'copy-code-button';
          button.innerHTML = `
            <svg class="copy-icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <svg class="check-icon w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          `;
          
          button.addEventListener('click', async () => {
            const code = pre.textContent;
            const copyIcon = button.querySelector('.copy-icon');
            const checkIcon = button.querySelector('.check-icon');
            
            try {
              await navigator.clipboard.writeText(code);
              copyIcon?.classList.add('hidden');
              checkIcon?.classList.remove('hidden');
              button.classList.add('copied');
              
              setTimeout(() => {
                copyIcon?.classList.remove('hidden');
                checkIcon?.classList.add('hidden');
                button.classList.remove('copied');
              }, 2000);
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          });
          
          wrapper.appendChild(button);
        });
      }
      
      // Run on page load
      document.addEventListener('DOMContentLoaded', addCopyButtons);
      
      // Also run after view transitions (for SPA navigation)
      document.addEventListener('astro:page-load', addCopyButtons);
    </script>

    <script>
      // ðŸ¤« Easter egg - shhh...
      console.log('%cType \'aoqi\' to verify identity.', 'color: #888; font-size: 10px;');

      let inputBuffer = '';
      const secretWord = 'aoqi';

      document.addEventListener('keydown', (e) => {
        // Only track letter keys
        if (e.key.length === 1 && e.key.match(/[a-z]/i)) {
          inputBuffer += e.key.toLowerCase();
          // Keep only last 4 characters
          if (inputBuffer.length > secretWord.length) {
            inputBuffer = inputBuffer.slice(-secretWord.length);
          }
          // Check for match
          if (inputBuffer === secretWord) {
            triggerFireworks();
            inputBuffer = '';
          }
        }
      });

      function triggerFireworks() {
        // Randomize the name variant
        const nameVariants = ['Ngaochi', 'Oke', 'Alchi', 'Aoki', 'Ochi', 'Au Kei', 'Aoqi', 'O Kei'];
        const randomName = nameVariants[Math.floor(Math.random() * nameVariants.length)];

        // Randomize the subtitle
        const subtitleVariants = ['Sentir sans dire.', 'Moonlight', 'some words are meant to be kept in heart'];
        const randomSubtitle = subtitleVariants[Math.floor(Math.random() * subtitleVariants.length)];

        // Create overlay
        const overlay = document.createElement('div');
        overlay.id = 'firework-overlay';
        overlay.innerHTML = `
          <canvas id="firework-canvas"></canvas>
          <div class="firework-message">
            <div class="firework-text">I Love You, ${randomName}</div>
            <div class="firework-subtitle">${randomSubtitle}</div>
          </div>
        `;
        document.body.appendChild(overlay);

        const canvas = document.getElementById('firework-canvas');
        const ctx = canvas.getContext('2d');
        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;

        const fireworks = [];
        const particles = [];
        const floatingDots = [];

        // Color palette - muted, melancholic tones
        const colors = [
          { r: 255, g: 182, b: 193, a: 0.8 },
          { r: 176, g: 196, b: 222, a: 0.7 },
          { r: 230, g: 230, b: 250, a: 0.6 },
          { r: 255, g: 218, b: 185, a: 0.5 },
          { r: 221, g: 160, b: 221, a: 0.4 },
          { r: 173, g: 216, b: 230, a: 0.6 },
        ];

        class FloatingDot {
          constructor() { this.reset(); }
          reset() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.size = Math.random() * 2 + 0.5;
            this.speedY = -Math.random() * 0.3 - 0.1;
            this.speedX = (Math.random() - 0.5) * 0.2;
            this.opacity = Math.random() * 0.3 + 0.1;
            this.color = colors[Math.floor(Math.random() * colors.length)];
          }
          update() {
            this.y += this.speedY;
            this.x += this.speedX;
            this.opacity -= 0.0005;
            if (this.y < 0 || this.opacity <= 0) {
              this.reset();
              this.y = height + 10;
            }
          }
          draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.opacity})`;
            ctx.fill();
          }
        }

        class Firework {
          constructor(x, y, targetY) {
            this.x = x; this.y = y; this.targetY = targetY;
            this.speed = 2 + Math.random();
            this.color = colors[Math.floor(Math.random() * colors.length)];
            this.trail = [];
          }
          update() {
            this.trail.push({ x: this.x, y: this.y });
            if (this.trail.length > 10) this.trail.shift();
            this.y -= this.speed;
            this.x += (Math.random() - 0.5) * 0.5;
            if (this.y <= this.targetY) {
              this.explode();
              return false;
            }
            return true;
          }
          explode() {
            const count = 30 + Math.floor(Math.random() * 20);
            for (let i = 0; i < count; i++) {
              const angle = (Math.PI * 2 / count) * i;
              const speed = 1 + Math.random() * 2;
              particles.push(new Particle(this.x, this.y, Math.cos(angle) * speed, Math.sin(angle) * speed, this.color));
            }
          }
          draw() {
            this.trail.forEach((p, i) => {
              ctx.beginPath();
              ctx.arc(p.x, p.y, 1.5, 0, Math.PI * 2);
              ctx.fillStyle = `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${(i / this.trail.length) * 0.3})`;
              ctx.fill();
            });
            ctx.beginPath();
            ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, 0.8)`;
            ctx.fill();
          }
        }

        class Particle {
          constructor(x, y, vx, vy, color) {
            this.x = x; this.y = y; this.vx = vx; this.vy = vy;
            this.color = color; this.life = 1;
            this.decay = 0.008 + Math.random() * 0.008;
            this.size = 1.5 + Math.random();
          }
          update() {
            this.x += this.vx; this.y += this.vy;
            this.vy += 0.02; this.vx *= 0.99; this.vy *= 0.99;
            this.life -= this.decay;
            return this.life > 0;
          }
          draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size * this.life, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.life * this.color.a})`;
            ctx.fill();
          }
        }

        for (let i = 0; i < 50; i++) floatingDots.push(new FloatingDot());

        function launchFirework() {
          const x = width * 0.2 + Math.random() * width * 0.6;
          const targetY = height * 0.2 + Math.random() * height * 0.3;
          fireworks.push(new Firework(x, height, targetY));
        }

        setTimeout(() => launchFirework(), 300);
        setTimeout(() => launchFirework(), 800);
        setTimeout(() => launchFirework(), 1500);
        const interval = setInterval(() => { if (Math.random() > 0.3) launchFirework(); }, 2000);

        let animationId;
        function animate() {
          ctx.fillStyle = 'rgba(12, 12, 30, 0.15)';
          ctx.fillRect(0, 0, width, height);
          floatingDots.forEach(d => { d.update(); d.draw(); });
          for (let i = fireworks.length - 1; i >= 0; i--) {
            fireworks[i].draw();
            if (!fireworks[i].update()) fireworks.splice(i, 1);
          }
          for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].draw();
            if (!particles[i].update()) particles.splice(i, 1);
          }
          animationId = requestAnimationFrame(animate);
        }
        animate();

        // Close on click or after 10 seconds
        const closeOverlay = () => {
          clearInterval(interval);
          cancelAnimationFrame(animationId);
          overlay.style.opacity = '0';
          setTimeout(() => overlay.remove(), 500);
        };

        overlay.addEventListener('click', closeOverlay);
        setTimeout(closeOverlay, 10000);
      }
    </script>

    <style is:global>
      #firework-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 99999;
        background: linear-gradient(135deg, #0c0c1e 0%, #1a1a2e 50%, #16213e 100%);
        transition: opacity 0.5s ease;
      }
      #firework-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
      .firework-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 10;
        opacity: 0;
        animation: fireworkFadeIn 2s ease-out 0.5s forwards;
      }
      .firework-text {
        font-size: clamp(1.5rem, 5vw, 3rem);
        font-weight: 300;
        font-family: Georgia, serif;
        letter-spacing: 0.1em;
        background: linear-gradient(135deg, #e8d5d5 0%, #f5e6e8 50%, #d4a5a5 100%);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        animation: fireworkBreathe 4s ease-in-out infinite;
      }
      .firework-subtitle {
        margin-top: 1rem;
        font-size: clamp(0.7rem, 2vw, 1rem);
        color: rgba(255, 255, 255, 0.3);
        font-style: italic;
        font-family: Georgia, serif;
        letter-spacing: 0.15em;
      }
      @keyframes fireworkFadeIn {
        from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      }
      @keyframes fireworkBreathe {
        0%, 100% { opacity: 0.8; }
        50% { opacity: 1; }
      }
    </style>
  </body>
</html>
