---
import BackgroundEffect from '../components/BackgroundEffect.astro';
import Header from '../components/Header.astro';
import EquationModal from '../components/EquationModal.astro';
import '../styles/global.css';

interface Props {
  title?: string;
}

const { title = "Ken Xiao" } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Ken Xiao's Personal Blog" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <script is:inline>
      // Check for saved theme preference
      const theme = (() => {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      })();
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  </head>
  <body class="min-h-screen flex flex-col font-sans">
    <BackgroundEffect />
    <EquationModal />
    <Header />
    <main class="flex-grow container mx-auto px-4 py-8">
      <slot />
    </main>
    <footer class="py-6 text-center text-sm opacity-60">
      &copy; {new Date().getFullYear()} Ken Xiao. All rights reserved.
    </footer>
    
    <script>
      // Add copy buttons to code blocks
      function addCopyButtons() {
        document.querySelectorAll('pre:not(.code-block-ready)').forEach(pre =>{
          pre.classList.add('code-block-ready');
          
          const wrapper = document.createElement('div');
          wrapper.className = 'code-block-wrapper';
          pre.parentNode.insertBefore(wrapper, pre);
          wrapper.appendChild(pre);
          
          const button = document.createElement('button');
          button.className = 'copy-code-button';
          button.innerHTML = `
            <svg class="copy-icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <svg class="check-icon w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          `;
          
          button.addEventListener('click', async () => {
            const code = pre.textContent;
            const copyIcon = button.querySelector('.copy-icon');
            const checkIcon = button.querySelector('.check-icon');
            
            try {
              await navigator.clipboard.writeText(code);
              copyIcon?.classList.add('hidden');
              checkIcon?.classList.remove('hidden');
              button.classList.add('copied');
              
              setTimeout(() => {
                copyIcon?.classList.remove('hidden');
                checkIcon?.classList.add('hidden');
                button.classList.remove('copied');
              }, 2000);
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          });
          
          wrapper.appendChild(button);
        });
      }
      
      // Run on page load
      document.addEventListener('DOMContentLoaded', addCopyButtons);
      
      // Also run after view transitions (for SPA navigation)
      document.addEventListener('astro:page-load', addCopyButtons);
    </script>

    <script>
      // ğŸ¤« Easter egg - shhh...
      console.log('%cType \'aoqi\' to verify identity.', 'color: #888; font-size: 10px;');

      let inputBuffer = '';
      const secretWord = 'aoqi';

      document.addEventListener('keydown', (e) => {
        // Only track letter keys
        if (e.key.length === 1 && e.key.match(/[a-z]/i)) {
          inputBuffer += e.key.toLowerCase();
          // Keep only last 4 characters
          if (inputBuffer.length > secretWord.length) {
            inputBuffer = inputBuffer.slice(-secretWord.length);
          }
          // Check for match
          if (inputBuffer === secretWord) {
            triggerHeartRain();
            inputBuffer = '';
          }
        }
      });

      function triggerHeartRain() {
        const hearts = ['â¤ï¸', 'ğŸ’•', 'ğŸ’–', 'ğŸ’—', 'ğŸ’“', 'ğŸ’˜', 'ğŸ’', 'ğŸ©·', 'ğŸ¤', 'ğŸ©µ'];
        const container = document.createElement('div');
        container.id = 'heart-rain';
        container.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:99999;overflow:hidden;';
        document.body.appendChild(container);

        // Create 50 hearts
        for (let i = 0; i < 50; i++) {
          setTimeout(() => {
            const heart = document.createElement('div');
            heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
            heart.style.cssText = `
              position: absolute;
              top: -50px;
              left: ${Math.random() * 100}%;
              font-size: ${20 + Math.random() * 30}px;
              animation: heartFall ${3 + Math.random() * 2}s linear forwards;
              opacity: ${0.7 + Math.random() * 0.3};
            `;
            container.appendChild(heart);
          }, i * 100);
        }

        // Show message
        const msg = document.createElement('div');
        msg.innerHTML = 'I Love You, Aoqi! ğŸ’•';
        msg.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 2.5rem;
          font-weight: bold;
          color: #ff6b9d;
          text-shadow: 0 0 20px rgba(255,107,157,0.5);
          z-index: 100000;
          animation: msgPulse 0.5s ease-in-out infinite alternate;
        `;
        container.appendChild(msg);

        // Remove after animation
        setTimeout(() => {
          container.remove();
        }, 8000);
      }
    </script>

    <style is:global>
      @keyframes heartFall {
        0% {
          transform: translateY(0) rotate(0deg);
        }
        100% {
          transform: translateY(100vh) rotate(360deg);
        }
      }
      @keyframes msgPulse {
        0% { transform: translate(-50%, -50%) scale(1); }
        100% { transform: translate(-50%, -50%) scale(1.1); }
      }
    </style>
  </body>
</html>
