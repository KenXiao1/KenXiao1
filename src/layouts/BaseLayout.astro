---
import BackgroundEffect from '../components/BackgroundEffect.astro';
import Header from '../components/Header.astro';
import EquationModal from '../components/EquationModal.astro';
import '../styles/global.css';

interface Props {
  title?: string;
}

const { title = "Ken Xiao" } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Ken Xiao's Personal Blog" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <script is:inline>
      // Check for saved theme preference
      const theme = (() => {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      })();
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  </head>
  <body class="min-h-screen flex flex-col font-sans">
    <BackgroundEffect />
    <EquationModal />
    <Header />
    <main class="flex-grow container mx-auto px-4 py-8">
      <slot />
    </main>
    <footer class="py-6 text-center text-sm opacity-60">
      &copy; {new Date().getFullYear()} Ken Xiao. All rights reserved.
    </footer>
    
    <script>
      // Add copy buttons to code blocks
      function addCopyButtons() {
        document.querySelectorAll('pre:not(.code-block-ready)').forEach(pre =>{
          pre.classList.add('code-block-ready');
          
          const wrapper = document.createElement('div');
          wrapper.className = 'code-block-wrapper';
          pre.parentNode.insertBefore(wrapper, pre);
          wrapper.appendChild(pre);
          
          const button = document.createElement('button');
          button.className = 'copy-code-button';
          button.innerHTML = `
            <svg class="copy-icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <svg class="check-icon w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          `;
          
          button.addEventListener('click', async () => {
            const code = pre.textContent;
            const copyIcon = button.querySelector('.copy-icon');
            const checkIcon = button.querySelector('.check-icon');
            
            try {
              await navigator.clipboard.writeText(code);
              copyIcon?.classList.add('hidden');
              checkIcon?.classList.remove('hidden');
              button.classList.add('copied');
              
              setTimeout(() => {
                copyIcon?.classList.remove('hidden');
                checkIcon?.classList.add('hidden');
                button.classList.remove('copied');
              }, 2000);
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          });
          
          wrapper.appendChild(button);
        });
      }
      
      // Run on page load
      document.addEventListener('DOMContentLoaded', addCopyButtons);
      
      // Also run after view transitions (for SPA navigation)
      document.addEventListener('astro:page-load', addCopyButtons);
    </script>
  </body>
</html>
